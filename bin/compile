#!/usr/bin/env bash
set -o errexit
set -o nounset
set -o pipefail
set -o verbose

if [[ -z "${INSTALL_DEST:-}" ]]; then
  echo "Missing INSTALL_DEST"
  exit 1
fi

if [[ -z "${VERSION:-}" ]]; then
  VERSION=$(curl -s https://www.python.org/downloads/ | grep -oP 'Download Python \K[0-9]+\.[0-9]+\.[0-9]+' | head -1)
  echo "Automatically determined Python version: $VERSION"
fi

VENV_HOME="$HOME/virtualenv"
mkdir -p "$VENV_HOME"

install_numpy() {
  "$VENV_HOME/$VIRTENV_VERSION/bin/pip" install --upgrade numpy
}

sudo env PYTHON_BUILD_ROOT=/opt/pyenv/plugins/python-build \
  /opt/pyenv/plugins/python-build/bin/python-build --verbose "$VERSION" "$INSTALL_DEST/$VERSION"

if [[ -n "${ALIAS:-}" ]]; then
  sudo rm -rf "$INSTALL_DEST/$ALIAS"
  sudo ln -sf "$INSTALL_DEST/$VERSION" "$INSTALL_DEST/$ALIAS"
fi

if [[ "$VERSION" == pypy3* ]]; then
  PYTHON_BIN="pypy3"
  VIRTENV_VERSION="$VERSION"
elif [[ "$VERSION" == pypy* ]]; then
  PYTHON_BIN="pypy"
  VIRTENV_VERSION="$VERSION"
else
  PYTHON_BIN="python"
  VIRTENV_VERSION="python$VERSION"
fi

PYTHON_CANDIDATES=($(compgen -c python3 | grep -E '^python3\.[0-9]+$' | sort -V -r))
if [[ ${#PYTHON_CANDIDATES[@]} -eq 0 ]]; then
  echo "No suitable Python3 version found in the system."
  exit 1
fi
PYTHON="${PYTHON_CANDIDATES[0]}"
echo "Using Python interpreter: $PYTHON"

sudo -H "$PYTHON" -m pip install virtualenv

"$PYTHON" -m virtualenv --python="$INSTALL_DEST/$VERSION/bin/$PYTHON_BIN" \
  --seeder=pip \
  "$VENV_HOME/$VIRTENV_VERSION"

if [[ -n "${ALIAS:-}" ]]; then
  if [[ "$ALIAS" == pypy* ]]; then
    VIRTENV_ALIAS="$ALIAS"
  else
    VIRTENV_ALIAS="python$ALIAS"
  fi
  rm -f "$VENV_HOME/$VIRTENV_ALIAS"
  ln -sf "$VENV_HOME/$VIRTENV_VERSION" "$VENV_HOME/$VIRTENV_ALIAS"
fi

"$VENV_HOME/$VIRTENV_VERSION/bin/python" -c "import sys; assert sys.maxunicode > 65535"

if [[ -n "${PACKAGES:-}" ]]; then
  "$VENV_HOME/$VIRTENV_VERSION/bin/pip" install --upgrade $PACKAGES
fi

if ! [[ "${ALIAS:-}" == "nightly" || "$VERSION" =~ -dev$ ]]; then
  if [[ "$VERSION" == pypy* ]]; then
    "$VENV_HOME/$VIRTENV_VERSION/bin/$PYTHON_BIN" -m ensurepip
  fi
  install_numpy
fi
