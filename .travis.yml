language: shell
dist: focal
group: dev

services:
  - elasticsearch

before_install:
  # Fix master node discovery issue - Option 1: Set single-node mode
  - sudo bash -c 'echo "discovery.type: single-node" >> /etc/elasticsearch/elasticsearch.yml'
  
  # Fix master node discovery issue - Option 2: Update node name to match config
  # (Use either Option 1 OR Option 2, not both)
  #- sudo bash -c 'echo "node.name: packer-67ed5627-475d-8373-5bba-592c1f1f289b" >> /etc/elasticsearch/elasticsearch.yml'
  
  # Restart Elasticsearch with new settings
  - sudo systemctl restart elasticsearch
  - sleep 20

script:
  # Test Elasticsearch availability
  - |
    MAX_RETRIES=10
    RETRY_COUNT=0
    until curl --silent -XGET --fail http://localhost:9200/_cluster/health?pretty || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
      echo "Attempt $RETRY_COUNT of $MAX_RETRIES - Elasticsearch still unavailable..."
      RETRY_COUNT=$((RETRY_COUNT+1))
      sleep 5
    done
    
    if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
      echo "Elasticsearch failed to start properly within the specified time"
      exit 1
    else
      echo "Elasticsearch is working properly"
    fi

after_failure:
  # Print diagnostics in case of failure
  - sudo cat /etc/elasticsearch/elasticsearch.yml | grep -v "^#" | grep .
  - sudo tail -n 100 /var/log/elasticsearch/elasticsearch.log
