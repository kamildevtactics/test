language: shell
dist: focal
group: dev

services:
  - elasticsearch

before_install:
  - |
    # Enable single-node discovery to avoid master node issues
    sudo bash -c 'echo "discovery.type: single-node" >> /etc/elasticsearch/elasticsearch.yml'
    # Restart Elasticsearch with the new configuration
    sudo systemctl restart elasticsearch
    # Wait for Elasticsearch to initialize
    sleep 20

script:
  - |
    # Retry logic to wait for Elasticsearch cluster to become green
    MAX_RETRIES=10
    RETRY_COUNT=0
    until curl --silent -XGET --fail http://localhost:9200/_cluster/health?pretty || [ "$RETRY_COUNT" -eq "$MAX_RETRIES" ]; do
      echo "Attempt $RETRY_COUNT of $MAX_RETRIES - Elasticsearch still unavailable..."
      RETRY_COUNT=$((RETRY_COUNT+1))
      sleep 5
    done

    if [ "$RETRY_COUNT" -eq "$MAX_RETRIES" ]; then
      echo "Elasticsearch failed to start properly within the specified time"
      exit 1
    else
      echo "Elasticsearch is working properly"
    fi
