language: shell
dist: jammy
group: dev

services:
  - elasticsearch  

before_install:
  # Zwiększenie limitów systemowych
  - sudo sysctl -w vm.max_map_count=262144
  
  # Napraw configuration.yml - bez wcięć na początku linii w dokumentach here 
  - |
    sudo bash -c "cat > /etc/elasticsearch/elasticsearch.yml << EOL
# Minimal Elasticsearch configuration for Travis CI
cluster.name: travis-elasticsearch
node.name: travis-elasticsearch-node

# Network settings
network.host: 127.0.0.1
http.port: 9200

# Discovery
discovery.type: single-node

# Disable security features
xpack.security.enabled: false

# Basic settings
http.cors.enabled: true
http.cors.allow-origin: \"*\"
EOL"
  
  # Zwiększ pamięć JVM
  - |
    sudo bash -c "cat > /etc/elasticsearch/jvm.options.d/memory.options << EOL
-Xms512m
-Xmx512m
EOL"
  
  # Napraw uprawnienia
  - sudo chown -R elasticsearch:elasticsearch /var/lib/elasticsearch
  - sudo chown -R elasticsearch:elasticsearch /var/log/elasticsearch
  
  # Przeładuj usługi
  - sudo systemctl daemon-reload
  
  # Spróbuj uruchomić usługę
  - sudo systemctl restart elasticsearch || true
  
  # Sprawdź status
  - sleep 3
  - sudo systemctl status elasticsearch || true
  
  # Pokaż logi
  - sudo cat /var/log/elasticsearch/travis-elasticsearch.log || true
  
  # Sprawdź czy działa
  - curl -v http://localhost:9200 || echo "Elasticsearch nie odpowiada"
  
  # Czekaj na uruchomienie (z timeoutem 30s)
  - timeout 30 bash -c 'until curl --silent -XGET --fail http://localhost:9200; do printf "."; sleep 3; done' || echo "Timeout podczas czekania na Elasticsearch"

script:
  - echo "Test completed"
