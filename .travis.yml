language: node_js
node_js:
  - 20.9             # LTS version
os: linux
arch: amd64
dist: jammy        # Ubuntu 22.04

# Cache npm to speed up builds
env:
  - NPM_CONFIG_PROGRESS=false  # disable progress bars
cache:
  directories:
    - ~/.npm

# Shallow clone speeds up git operations
git:
  depth: 1
  quiet: true
  submodules: false

before_install:
  # Diagnostics: run all checks in one shell block to avoid YAML parsing issues
  - |
    echo "--- Environment diagnostics ---"
    echo "Platform: $(uname -a)"
    echo "OS release: $(lsb_release -a 2>/dev/null || true)"
    echo "Node version: $(node -v)"
    echo "npm version: $(npm -v)"
    echo "Git version: $(git --version)"
    echo "DNS lookup (codeload.github.com):"; nslookup codeload.github.com || true
    echo "Ping test (codeload.github.com, 3 packets):"; ping -c 3 codeload.github.com || true
    echo "HTTP HEAD (Docsy tarball):"; curl -I https://codeload.github.com/google/docsy/tar.gz/712aa05897c1abe239786522131e83d69e5e1b4e || true

  # Install dependencies with extended timeout
  - npm config set loglevel verbose
  - travis_wait 30 npm install --prefer-offline

script:
  - echo "npm install completed successfully"
  # dalej np. npm test lub ./node_modules/.bin/hugo
