language: minimal

os: linux
dist: jammy

jobs:
  include:
    - name: "Check Podman Installation and Install if Not Present"
      script:
        # Check if podman is installed initially
        - echo "Checking if Podman is installed..."
        - command -v podman >/dev/null 2>&1 && echo "Podman is already installed" || echo "Podman is NOT installed"
        
        # Install Podman and required dependencies
        - echo "Installing Podman and dependencies..."
        - sudo apt-get update
        - sudo apt-get install -y podman uidmap slirp4netns fuse-overlayfs
        
        # Configure subuid and subgid for rootless mode
        - sudo usermod --add-subuids 100000-165535 $USER
        - sudo usermod --add-subgids 100000-165535 $USER
        - grep $USER /etc/subuid /etc/subgid || echo "Failed to set subuid/subgid"
        
        # Verify installation was successful
        - echo "Verifying Podman installation..."
        - podman --version
        
        # Check podman service
        - systemctl list-unit-files | grep podman || echo "No Podman service found"
        
        # Check package information
        - dpkg -l | grep -i podman
        
        # Test basic functionality
        - echo "Testing Podman functionality..."
        - podman info || echo "Could not get Podman info"
        - podman pull hello-world || echo "Could not pull hello-world image"
        - podman run hello-world || echo "Could not run hello-world container"
        
        # Alternative: try to run as root
        - echo "Trying to run Podman as root..."
        - sudo podman info
        - sudo podman pull hello-world
        - sudo podman run hello-world
